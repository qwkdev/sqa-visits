<!DOCTYPE html>
<html lang="en">
<head>
	<title>Visit Tracker | SQA.MY</title>
	<style>
		:root {
			--u: 1.4vh;

			--bg: #161617;
			/* --bg2: #222223; */
			--bg2: #333334;
			--bg3: #444445;

			--grid: round(calc(2 * var(--u)), 10px);
		}

		body {
			margin: 0;
			background: var(--bg);
			background-image: linear-gradient(0deg, var(--bg2) 0, var(--bg2) 1px, transparent 1px, transparent 100%),
						linear-gradient(90deg, var(--bg2) 0, var(--bg2) 1px, transparent 1px, transparent 100%);
			background-size: var(--grid) var(--grid);
		}

		#grid {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			box-sizing: border-box;

			display: grid;

			padding: round(calc(3 * var(--u)), 10px);
			gap: calc(1 * var(--u));
		}
		.panel {
			width: 100%;
			height: 100%;
			background: var(--bg);
			border: 1px solid var(--bg2);
			padding: calc(1 * var(--u));
			box-sizing: border-box;
			font-family: monospace;
			color: #fff;
			position: relative;
		}
		.panel h1, .panel h2, .panel h3, .panel p {
			margin: 0;
		}
		.panel h1 {
			font-size: calc(4 * var(--u));
			font-weight: 700;
		}
		.panel h1 span {
			font-size: calc(2 * var(--u));
		}
		.panel h2 {
			font-size: calc(1.5 * var(--u));
			font-weight: 700;
		}
		.panel h2 span {
			font-size: calc(1 * var(--u));
		}
		.panel h3, .panel p {
			font-size: calc(1.2 * var(--u));
			font-weight: 500;
		}
		.panel h3 span, .panel p span {
			font-size: calc(1 * var(--u));
		}
		.panel span {
			margin-left: calc(.5 * var(--u));
			font-weight: 500;
		}
		.panel span.positive {
			color: #0f0;
		}
		.panel span.negative {
			color: #f00;
		}
		.panel .center {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}
		.panel.list {
			height: 100%;
			overflow-y: scroll;
		}
		.panel.list .title {
			margin-bottom: calc(1 * var(--u));
		}
		.panel.list .row {
			border-top: 1px solid var(--bg2);
			padding: calc(1 * var(--u)) 0;
			display: grid;
			grid-template-columns: 1fr auto;
			grid-template-rows: auto auto;
			align-items: center;
		}
		.panel.list .row h3 {
			grid-column: 1;
			grid-row: 1;
		}
		.panel.list .row p {
			grid-column: 1;
			grid-row: 2;
		}
		.panel.list .row h2 {
			grid-column: 2;
			grid-row: 1 / span 2;
		}
		.panel.list .row:last-of-type {
			padding-bottom: 0;
		}
		.panel.graph h2 {
			margin-bottom: calc(.5 * var(--u));
		}
		#chart {
			width: 95%;
			height: min-content;
			position: absolute;
			top: 50%;
			left: 49%;
			transform: translate(-50%, -50%);
		}

		.apexcharts-text {
			fill: #fff !important;
		}
		.apexcharts-legend-text {
			color: #fff !important;
		}
		.apexcharts-gridline {
			stroke: var(--bg3) !important;
		}
		.apexcharts-tooltip.apexcharts-theme-light {
			background: var(--bg) !important;
			border: 1px solid var(--bg2) !important;
		}
		.apexcharts-tooltip-title {
			background: var(--bg2) !important;
			border-bottom: 1px solid var(--bg3) !important;
		}
		.apexcharts-heatmap-rect[val='0'] {
			fill: transparent !important;
			stroke: transparent !important;
		}
		.apexcharts-svg {
			background: transparent !important;
		}

		@media only screen and (max-aspect-ratio: 1/1) {
			:root {
				--u: 2vw;
			}
		}

		#title {
			width: max-content;
		}
		#grid {
			grid-template-columns: 3fr 1fr 1fr 3fr;
			grid-template-rows: auto auto
				calc(35 * var(--u))
				max(30vw, 20vh)
				auto auto;
			grid-template-areas: 
				't t t t'
				'v1 v1 v2 v2'
				'l c c c'
				'h h h h'
				'd1 d1 d2 d2'
				'd3 d3 d4 d4';
		}
		@media only screen and (max-aspect-ratio: 1/1.7) {
			#grid {
				grid-template-columns: 1fr;
				grid-template-rows: auto auto auto
					calc(25 * var(--u))
					calc(30 * var(--u))
					calc(20 * var(--u))
					repeat(4, auto);
				grid-template-areas: 't''v1''v2''l''c''h''d1''d2''d3''d4';
			}
		}
		@media only screen and (min-aspect-ratio: 1.2/1) {
			#title {
				width: 100%;
			}
			#grid {
				grid-template-columns: 1fr 1fr 1fr 1fr;
				grid-template-rows: auto
					auto auto calc(20 * var(--u)) calc(25 * var(--u))
					auto;
				grid-template-areas: 
					't c c c'
					'v1 c c c'
					'v2 c c c'
					'l c c c'
					'l h h h'
					'd1 d2 d3 d4';
			}
		}
	</style>
</head>
<body>
	<div id="grid">
		<div class="panel" id="title" style="grid-area: t;">
			<h2>visits.sqa.my &bullet; qTrack &bullet; v3.1.0</h2>
		</div>
		<div class="panel" style="grid-area: v1">
			<h2>Total Visits</h2>
			<h1 id="total-visits"></h1>
		</div>
		<div class="panel" style="grid-area: v2">
			<h2>Visits today</h2>
			<h1 id="today-visits"></h1>
		</div>
		<div class="panel list" id="subjects" style="grid-area: l">
			<div class="title">
				<h2>Top Subjects this week</h2>
			</div>
		</div>
		<div class="panel graph" style="grid-area: c">
			<div id="chart"></div>
		</div>
		<div class="panel graph" style="grid-area: h">
			<div id="heatmap"></div>
		</div>
		<div class="panel graph" style="grid-area: d1">
			<h2>Qualification Levels</h2>
			<div id="level-donut"></div>
		</div>
		<div class="panel graph" style="grid-area: d2">
			<h2>Operating Systems</h2>
			<div id="os-donut"></div>
		</div>
		<div class="panel graph" style="grid-area: d3">
			<h2>Browsers</h2>
			<div id="browser-donut"></div>
		</div>
		<div class="panel graph" style="grid-area: d4">
			<h2>Referrer Urls</h2>
			<div id="referrer-donut"></div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<script>
		const subnames = { "admin": "Admin", "accounting": "Accounting", "esol": "ESOL", "politics": "Politics", "dance": "Dance", "apps": "Apps", "art": "Art", "bio": "Biology", "business": "Business", "canto": "Canto", "chem": "Chemistry", "computing": "Computing", "dm": "D&M", "drama": "Drama", "engineering": "Engineering", "english": "English", "french": "French", "geo": "Geography", "graphics": "Graphics", "history": "History", "humanbio": "Human Bio", "maths": "Maths", "mody": "Mody", "music": "Music", "musictech": "Music Tech", "philosophy": "Philosophy", "photography": "Photography", "pe": "PE", "physics": "Physics", "rmps": "RMPS", "spanish": "Spanish" };
		
		function strip(str, remove, right=false) {
			if (right) return str.endsWith(remove) ? str.slice(0, -remove.length) : str;
			return str.startsWith(remove) ? str.slice(remove.length) : str;
		}
		function round(num, places) {
			const factor = Math.pow(10, places);
			const resp = Math.round(num * factor) / factor;
			return resp == Math.round(resp) ? Math.round(resp) : resp
		}
		function formatNumber(num) {
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
		}

		function getDay(iso) {
			const resp = (new Date(iso)).getDay();
			if (resp === 0) return 6;
			return resp - 1
		}
		function getWeekBeginning(iso) {
			const start = new Date(iso);
			const delta = start.getDate() - getDay(iso);
			return new Date(start.setDate(delta));
		}
		function formatDate(date) {
			return date.toLocaleDateString('en-GB', {
				month: 'short', day: '2-digit'
			});
		}
		function countVisits(data, prefix) {
			return Object.entries(data)
				.filter(([k, _]) => k.startsWith(prefix+'-') || k == prefix)
				.reduce((sum, [_, v]) => sum + v, 0);
		}
		function subjectVisits(data) {
			let resp = {};
			for (const key in data) {
				if (key.startsWith('sqa-') && key.split('-').length >= 3) {
					const sub = key.split('-')[2];
					if (!resp[sub]) {
						resp[sub] = 0;
					}
					resp[sub] += data[key];
				}
			}
			return resp
		}
		function addObjects(data1, data2) {
			let resp = data1;
			for (const key in data2) {
				if (!resp[key]) resp[key] = 0;
				resp[key] += data2[key];
			}
			return resp;
		}

		function donutGraph(elementId, rawData, threshold=0) {
			let data;
			if (threshold === 0) data = rawData;
			else {
				let total = Object.values(rawData).reduce((a, b) => a + b, 0);
				let other = 0;
				data = {};

				for (const key in rawData) {
					if ((rawData[key] / total) > threshold) data[key] = rawData[key];
					else other += rawData[key];
				}
				if (other > 0) data['Other'] = other;
			}

			const donut = new ApexCharts(document.getElementById(elementId), {
				chart: {
					type: 'donut',
				},
				series: Object.values(data),
				labels: Object.keys(data),
				colors: [
					'#33aaff',
					'#7755dd',
					'#22ffbb',
					// '#3366ff',
					'#ff4466',
					'#ffbb22',
				],
				plotOptions: {
					pie: {
						useFillColorAsStroke: true,
						minAngleToShowLabel: 10,
					},
				},
				stroke: {
					show: false
				},
				dataLabels: {
					enabled: true,
					formatter: function (val) {
						return Math.round(val) + "%"
					}
				}
			});
			donut.render()
		}

		function graph(data) {
			const totalVisits = Object.entries(data).map(
				([k, v]) => ({ x: k, y: countVisits(v, 'sqa') })
			);
			const homeVisits = Object.entries(data).map(
				([k, v]) => ({ x: k, y: v['sqa'] ?? 0 })
			);

			let chart = new ApexCharts(document.getElementById('chart'), {
				chart: {
					type: 'area',
					height: '95%',
					zoom: {
						enabled: true,
						type: 'x',
						autoScaleYaxis: true
					}
				},
				series: [{
					name: 'Total Visits',
					data:  totalVisits
				}, {
					name: 'Home Page Visits',
					data: homeVisits
				}],
				xaxis: {
					type: 'datetime'
				},
				colors: [
					'#33aaff', '#22ffbb'
				],
				dataLabels: {
					enabled: false,
				},
			});
			chart.render().then(() => {
				const zoomStart = new Date();
				const zoomEnd = new Date();
				zoomStart.setDate(zoomStart.getDate() - 30);
				zoomEnd.setDate(zoomEnd.getDate() - 1);

				chart.zoomX(
					zoomStart.getTime(),
					zoomEnd.getTime()
				);
			});

			let weekdayData = [[], [], [], [], [], [], []];
			let initialDate = formatDate(getWeekBeginning(totalVisits[0].x));
			for (let i = 0; i < getDay(totalVisits[0].x); i++) {
				weekdayData[i].push({ x: initialDate, y: 0 });
			}
			totalVisits.forEach(e => weekdayData[getDay(e.x)].push({
				x: formatDate(getWeekBeginning(e.x)),
				y: e.y
			}));

			const series = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
					.map((k, n) => ({ name: k, data: weekdayData[n]}));
			series.reverse();

			const maxVisits = totalVisits.reduce((m, e) => e.y > m ? e.y : m, -Infinity);

			let heatmap = new ApexCharts(document.getElementById('heatmap'), {
				chart: {
					type: 'heatmap',
					height: '100%'
				},
				series: series,
				plotOptions: {
					heatmap: {
						radius: 0,
						useFillColorAsStroke: true,
						colorScale: {
							ranges: [{
								from: 0,
								to: 99,
								color: '#ff9933',
								name: '<100'
							}, {
								from: 100,
								to: 999,
								color: '#33aaff',
								name: '100-1000'
							}, {
								from: 999,
								to: maxVisits,
								color: '#22ffbb',
								name: '>1000'
							}]
						},
					},
				},
				theme: {
					mode: 'dark'
				},
				stroke: {
					width: 1
				},
				dataLabels: {
					enabled: false,
				}
			});
			heatmap.render();
		}
		
		async function init() {
			const counters = await (await fetch('https://qtrack.pythonanywhere.com/counters')).json();
			const visitCounters = Object.fromEntries(
				Object.entries(counters).map(([k, v]) => [k, v.v])
			);
			const total = countVisits(visitCounters, 'sqa');
			document.getElementById('total-visits').innerText = formatNumber(total);

			donutGraph('level-donut', {
				'Nat 5': countVisits(visitCounters, 'sqa-n5'),
				'Higher': countVisits(visitCounters, 'sqa-h'),
				'Adv Higher': countVisits(visitCounters, 'sqa-ah')
			});

			const history = await (await fetch('https://qtrack.pythonanywhere.com/counters/history')).json();
			graph(history);
			
			const today = await (await fetch('https://qtrack.pythonanywhere.com/counters/today')).json();
			// <!-- TODO: Refactor
			const yesterday = new Date();
			yesterday.setDate(yesterday.getDate() - 1);
			let yiso = yesterday.toISOString().split('T')[0];

			const hvt = countVisits(today, 'sqa');
			const hvy = countVisits(history[yiso], 'sqa');

			const change = round(((hvt - hvy)/(hvy > 0 ? hvy : 1))*100, 1);
			document.getElementById('today-visits').innerHTML = `${formatNumber(hvt)}<span class="${change >= 0 ? 'positive">+' : 'negative">'}${change}%</span>`;

			let tweek = subjectVisits(today);
			tweek = addObjects(tweek, subjectVisits(history[yiso]));
			for (let i = 0; i < 5; i++) {
				yesterday.setDate(yesterday.getDate() - 1);
				yiso = yesterday.toISOString().split('T')[0];
				tweek = addObjects(tweek, subjectVisits(history[yiso] ?? {}));
			}

			yesterday.setDate(yesterday.getDate() - 1);
			yiso = yesterday.toISOString().split('T')[0];
			let lweek = subjectVisits(history[yiso]);
			for (let i = 0; i < 6; i++) {
				yesterday.setDate(yesterday.getDate() - 1);
				yiso = yesterday.toISOString().split('T')[0];
				lweek = addObjects(lweek, subjectVisits(history[yiso] ?? {}));
			}

			const totalsub = subjectVisits(visitCounters);

			const list = document.getElementById('subjects');
			const sorted = Object.entries(tweek).sort((a, b) => b[1] - a[1]);
			for (const [k, v] of sorted) {
				const sub = document.createElement('div');
				sub.classList.add('row');
				const lwv = lweek[k] ?? 0;
				let span = '';
				if (lwv > 0) {
					const change = round(((v - lwv)/lwv)*100, 1);
					span = `<span class="${change >= 0 ? 'positive">+' : 'negative">'}${change}%</span>`;
				}
				sub.innerHTML = `<h3>${subnames[k] ?? k}</h3><p>${formatNumber(v)}${span}</p><h2>${formatNumber(totalsub[k] ?? 0)}</h2>`;
				list.appendChild(sub);
			}
			// -->
			
			const events = (await (await fetch('https://qtrack.pythonanywhere.com/events')).json())['data'];
			const eventOsData = {'Unknown': 0};
			const eventBrowserData = {'Unknown': 0};
			const eventReferrerData = {'None': 0};

			events.forEach(e => {
				if (!e.tracker.startsWith('sqa')) return;
				let os = e.os ?? 'Unknown';
				let browser = e.browser ?? 'Unknown';
				let referrer = e.referrer ?? 'None';
				referrer = strip(referrer, 'https://');
				referrer = strip(referrer, 'http://');
				referrer = strip(referrer, 'www.');
				referrer = strip(referrer, '/', true);

				eventOsData[os] = (eventOsData[os] || 0) + 1;
				eventBrowserData[browser] = (eventBrowserData[browser] || 0) + 1;
				eventReferrerData[referrer] = (eventReferrerData[referrer] || 0) + 1;
			});

			donutGraph('os-donut', eventOsData, 0.01);
			donutGraph('browser-donut', eventBrowserData, 0.01);
			donutGraph('referrer-donut', eventReferrerData, 0.01);
		}

		init();
	</script>
</body>
</html>
